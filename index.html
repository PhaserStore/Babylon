<!doctype html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Virtual Gallery ‚Äî LED ¬∑ Layout ¬∑ URL loader</title>

  <style>
    html,body{width:100%;height:100%;margin:0;overflow:hidden;background:#111;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    #renderCanvas{width:100%;height:100%;display:block;touch-action:none}

    /* ===== ADMIN UI ===== */
    #ui{
      position:fixed;top:12px;left:12px;right:12px;z-index:10;
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
      background:rgba(15,15,18,.65);border:1px solid rgba(255,255,255,.15);
      border-radius:10px;padding:10px 12px;color:#fff;backdrop-filter:blur(6px)
    }
    .group{display:flex;gap:8px;align-items:center;background:rgba(40,40,44,.5);padding:8px 10px;border-radius:8px}
    input,button,textarea{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#3a3a3a;color:#fff}
    button:hover{background:#575757}
    textarea{min-width:320px;min-height:80px}
    #hint{flex-basis:100%;font-size:12px;color:#ccc}
    /* VIEW m√≥d = ƒçist√° v√Ωstava (UI nevidƒõt) */
    body.view #ui{display:none}
    label{display:flex;gap:6px;align-items:center}

    /* Publish btn ‚Äì vidƒõt jen v ADMIN m√≥du */
    #publishBtn{
      position:fixed;top:12px;right:12px;z-index:9999;padding:8px 12px;
      display:none;
    }
    body.admin #publishBtn{ display:inline-flex; }
  </style>

  <!-- Babylon.js + GUI -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
</head>

<body class="view">
  <!-- Publish to GitHub Issue (jen v ADMIN m√≥du) -->
  <button id="publishBtn" title="Publikovat JSON do GitHub Issue">Publish to GitHub</button>

  <!-- ===== UI (ADMIN ‚Äì zobraz√≠ se a≈æ po kl√°vese A) ===== -->
  <div id="ui">
    <div class="group">
      <label>URL <input id="imgUrl" size="38" placeholder="https://... (.avif/.jpg/.png/.webp)"></label>
      <button id="btnLoad">Naƒç√≠st do vybran√©ho r√°mu</button>
      <button id="btnDemo">Naƒç√≠st DEMO bez URL</button>
    </div>

    <div class="group">
      <label>N√°zev <input id="title" placeholder="N√°zev d√≠la" size="16"></label>
      <label>Skryt√° URL <input id="link" placeholder="https://..." size="18"></label>
      <button id="btnPlacard">Aktualizovat cedulku</button>
    </div>

    <div class="group">
      <label>√ösek X od <input id="lxStart" type="number" step="0.1" value="-6.5" style="width:80px"></label>
      <label>do <input id="lxEnd" type="number" step="0.1" value="6.5" style="width:80px"></label>
      <label>Mezera <input id="lxSpace" type="range" min="1.6" max="3.0" step="0.1" value="2.2"></label>
      <button id="btnApplyLayout">Pou≈æ√≠t layout</button>
      <button id="btnAdd">‚ûï P≈ôidat r√°m</button>
      <button id="btnResetCam">üé• Reset kamery</button>
    </div>

    <div id="hint">A = ADMIN ¬∑ V = VIEW ¬∑ Klik na r√°m = v√Ωbƒõr (modr√Ω lem). Dvojklik = p≈ôibl√≠≈æen√≠. Klik na cedulku = skryt√° URL.</div>
  </div>

  <!-- ===== Canvas ===== -->
  <canvas id="renderCanvas"></canvas>

  <!-- Publish + loader (dr≈æ√≠me v HTML kv≈Øli early-boot) -->
  <script>
    // === SERIALIZACE: aktu√°ln√≠ stav galerie do JSON ===
    function collectGalleryData() {
      const out = { front: [], back: [], left: [], right: [] };
      if (!window.framesByWall) return out;
      for (const wall of Object.keys(framesByWall)) {
        out[wall] = (framesByWall[wall] || []).map(it => ({
          img:     it.data.src      || '',
          imgData: it.data.srcData  || '',
          label:   it.data.title    || '',
          href:    it.data.url      || ''
        }));
      }
      return out;
    }
    function getGalleryData() {
      try { if (window.framesByWall) return collectGalleryData(); } catch(e) {}
      const draft = localStorage.getItem('draftGalleryJson');
      if (draft) { try { return JSON.parse(draft); } catch(e) {} }
      return {};
    }
    function openPrefilledIssueWithJson(jsonString) {
      const title = encodeURIComponent('Update gallery');
      const body  = encodeURIComponent(jsonString);
      // D≈ÆLE≈ΩIT√â: &body= (≈æ√°dn√© HTML entity)
      const url   = `https://github.com/PhaserStore/Babylon/issues/new?title=${title}&body=${body}`;
      window.open(url, '_blank', 'noopener');
    }
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('publishBtn');
      btn.addEventListener('click', () => {
        if (document.body.classList.contains('view')) {
          alert('Publish je dostupn√Ω jen v ADMIN m√≥du (kl√°vesa A).');
          return;
        }
        try {
          const dataObj = getGalleryData();
          const minified = JSON.stringify(dataObj);
          JSON.parse(minified);
          localStorage.setItem('draftGalleryJson', minified);
          openPrefilledIssueWithJson(minified);
        } catch (e) {
          console.error(e);
          alert('Export selhal ‚Äì zkontroluj, ≈æe getGalleryData() vrac√≠ validn√≠ data (JS objekt).');
        }
      });
    });

    // ‚Äî Naƒçten√≠ ./data/gallery.json (je-li) ‚Äî
    async function loadGallery() {
      try {
        const res = await fetch('./data/gallery.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        window.galleryData = data;
        console.log('Naƒçteno data/gallery.json:', data);
        if (window.assignDataAllWalls) assignDataAllWalls(data, /*quiet*/true);
      } catch (e) {
        console.warn('Nepoda≈ôilo se naƒç√≠st data/gallery.json (mo≈æn√° zat√≠m neexistuje).', e);
      }
    }
    loadGallery();
  </script>

  <!-- Main script -->
  <script src="./script.js"></script>
</body>
</html>
