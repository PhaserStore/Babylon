<!doctype html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Virtual Gallery ‚Äî LED ¬∑ Layout ¬∑ Publish</title>

  <!-- ‚úÖ Poppins font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --ui-bg: rgba(15,15,18,.65);
      --ui-brd: rgba(255,255,255,.15);
      --ui-chip: rgba(40,40,44,.5);
      --txt:#fff; --txt-dim:#ccc;
      --touch:44px;
      --safe-top: env(safe-area-inset-top);
      --safe-right: env(safe-area-inset-right);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);

      /* === Dock player colors (SoundCloud-like) === */
      --dock-bg: #2a2a2a;         /* tmav√° li≈°ta */
      --dock-brd: #1e1e1e;        /* horn√≠ linka */
      --dock-txt: #ffffff;        /* prim√°rn√≠ text */
      --dock-dim: #cfcfcf;        /* sekund√°rn√≠ text */
      --dock-accent: #f50;        /* oran≈æov√° progress */
      --dock-rail: #505050;       /* kolejnice progressu */
      --dock-rail-dim: #3b3b3b;
    }
    html,body{
      width:100%;height:100%;margin:0;overflow:hidden;background:#111;
      font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);
    }
    #renderCanvas{
      position:fixed;inset:0;display:block;touch-action:none;width:100vw;height:100vh;
      will-change: transform; transform: translateZ(0);
    }

    /* ===== ADMIN UI ===== */
    #ui{
      position:fixed;left:12px;right:12px;top:calc(12px + var(--safe-top));z-index:10;
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;
      background:var(--ui-bg);border:1px solid var(--ui-brd);
      border-radius:12px;padding:10px 12px;color:#fff;backdrop-filter:blur(6px);
      -webkit-backdrop-filter: blur(6px);
      overflow:auto; scrollbar-width:thin; max-height:40vh;
    }
    @media (max-width: 900px){
      #ui{flex-wrap:nowrap;overflow:auto;white-space:nowrap;}
      #ui::-webkit-scrollbar{height:6px}
    }
    .group{display:flex;gap:8px;align-items:center;background:var(--ui-chip);padding:8px 10px;border-radius:10px}
    input,button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#3a3a3a;color:#fff;min-height:36px}
    input[type="number"]{width:80px}
    input[type="color"]{padding:0 4px;height:36px;min-width:44px;border-radius:8px;background:#3a3a3a}
    button{cursor:pointer} button:hover{background:#575757}
    label{display:flex;gap:6px;align-items:center}
    #hint{flex-basis:100%;font-size:12px;color:var(--txt-dim);white-space:normal}

    /* VIEW m√≥d = ƒçist√° v√Ωstava (UI nevidƒõt) */
    body.view #ui{display:none}

    /* Publish btn ‚Äî respekt safe-area */
    #publishBtn{
      position:fixed;top:calc(12px + var(--safe-top));right:calc(12px + var(--safe-right));
      z-index:9999;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);
      background:#212121;color:#fff
    }
    body.view #publishBtn{display:none}

    /* === P≈Øvodn√≠ SC bloky skryjeme (nahrazuje je dock) === */
    #scWrap, #scControls { display:none !important; }

    /* === Hidden host for SC iframe (API ovl√°d√°n√≠) === */
    #scIframeHidden {
      position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; pointer-events:none;
    }

    /* === Bottom Dock Player === */
    #scDock {
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:9998;
      color:var(--dock-txt);
      background:linear-gradient(to top, #232323 0%, #2b2b2b 100%);
      border-top:1px solid var(--dock-brd);
      box-shadow: 0 -2px 16px rgba(0,0,0,.35);
      padding:10px 14px calc(10px + var(--safe-bottom));
      display:flex;
      align-items:center;
      gap:14px;
      user-select:none;
    }
    /* lev√° sekce: transport */
    .dock-transport{
      display:flex; align-items:center; gap:10px; min-width:220px;
    }
    .btn{
      display:grid; place-items:center;
      width:36px; height:36px; border-radius:10px;
      background:#3a3a3a; border:1px solid rgba(255,255,255,.2);
      color:#fff; cursor:pointer; transition:.15s;
    }
    .btn:hover{ background:#575757 }
    .btn--round{
      width:44px; height:44px; border-radius:999px; background:#fff; color:#111; border:none;
    }
    .btn--icon{ line-height:0; }
    .btn svg{ width:18px; height:18px; fill:currentColor; }
    .btn--round svg{ width:20px; height:20px; }

    /* st≈ôed: seek */
    .dock-center{
      display:flex; align-items:center; gap:10px; flex:1; min-width:240px;
    }
    .time{
      font-size:12px; color:var(--dock-dim); width:44px; text-align:center;
      font-variant-numeric: tabular-nums;
    }
    .seek{
      position:relative; height:8px; flex:1;
      background:linear-gradient(#3a3a3a,#373737);
      border-radius:999px; border:1px solid #1e1e1e;
      overflow:hidden; cursor:pointer;
    }
    .seek-rail{ position:absolute; inset:0; background:linear-gradient(to right, var(--dock-rail), var(--dock-rail-dim)); }
    .seek-fill{ position:absolute; inset:0 100% 0 0; background:var(--dock-accent); }
    .seek-handle{
      position:absolute; top:50%; transform:translate(-50%,-50%); width:12px; height:12px;
      border-radius:50%; background:#fff; border:2px solid #111; box-shadow:0 0 0 2px rgba(0,0,0,.25);
      left:0%;
    }

    /* prav√° sekce: hlasitost + info */
    .dock-right{
      display:flex; align-items:center; gap:14px; min-width:280px; justify-content:flex-end;
    }
    .vol{ display:flex; align-items:center; gap:8px; min-width:140px; }
    .vol-rail{
      position:relative; width:110px; height:8px; border-radius:999px;
      background:linear-gradient(#3a3a3a,#373737); border:1px solid #1e1e1e; cursor:pointer; overflow:hidden;
    }
    .vol-fill{ position:absolute; inset:0 100% 0 0; background:#bfbfbf; }
    .track{
      display:flex; align-items:center; gap:10px; max-width:360px; overflow:hidden;
    }
    .art{
      width:36px; height:36px; border-radius:6px; background:#1f1f1f; flex:0 0 auto; overflow:hidden;
      box-shadow:0 0 0 1px rgba(255,255,255,.08) inset;
    }
    .art img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{
      display:flex; flex-direction:column; min-width:0;
    }
    .title{
      font-size:14px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:300px;
    }
    .artist{
      font-size:12px; color:var(--dock-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:300px;
    }

    @media (max-width: 720px){
      .artist{ display:none; }
      .dock-right{ min-width:220px; }
      .vol{ min-width:120px; }
      .vol-rail{ width:90px; }
    }

    /* aby obsah nebyl pod li≈°tou (kdyby nƒõkde scroll), tady jen prevence */
    body{ padding-bottom: calc(60px + var(--safe-bottom)); }
  </style>

  <!-- ‚úÖ Babylon.js + GUI -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>

  <!-- ‚ö†Ô∏è SoundCloud API naƒçteme dynamicky a≈æ p≈ôi Play -->
</head>

<!-- Startujeme rovnou ve VIEW m√≥du -->
<body class="view">
  <button id="publishBtn">Publish to GitHub</button>

  <!-- ===== UI ===== -->
  <div id="ui">
    <div class="group">
      <strong>Nastaven√≠:</strong>
      <label>Ochrann√° z√≥na&nbsp;<input id="safeWall" type="number" step="0.05" value="1" /></label>
      <label>Rohov√° rezerva&nbsp;<input id="cornerSafe" type="number" step="0.05" value="1" /></label>
    </div>

    <div class="group">
      <strong>Poƒçty r√°m≈Ø:</strong>
      <label>Front&nbsp;<input id="cntFront" type="number" step="1" min="0" value="4" style="width:70px"></label>
      <label>Back&nbsp;<input  id="cntBack"  type="number" step="1" min="0" value="4" style="width:70px"></label>
      <label>Left&nbsp;<input  id="cntLeft"  type="number" step="1" min="0" value="7" style="width:70px"></label>
      <label>Right&nbsp;<input id="cntRight" type="number" step="1" min="0" value="7" style="width:70px"></label>
    </div>

    <div class="group">
      <strong>R√°m:</strong>
      <label>≈†√≠≈ôka&nbsp;<input  id="frmW"      type="number" step="0.05" value="2"></label>
      <label>V√Ω≈°ka&nbsp;<input  id="frmH"      type="number" step="0.05" value="2"></label>
      <label>Li≈°ta&nbsp;<input  id="frmBorder" type="number" step="0.02" value="0.08"></label>
      <label>Barva&nbsp;<input  id="frmColor"  type="color"  value="#717171"></label>
    </div>

    <div class="group">
      <button id="btnApplyLayout">Pou≈æ√≠t layout</button>
      <button id="btnResetCam">üé• Reset kamery</button>
    </div>

    <div id="hint">A = ADMIN (jen desktop) ¬∑ V = VIEW (jen desktop) ¬∑ Dvojklik/Double‚Äëtap = p≈ôibl√≠≈æen√≠ na bod. Klik na cedulku = skryt√° URL.</div>
  </div>

  <!-- ====== Hidden SC iframe host (pro API) ====== -->
  <div id="scIframeHidden" aria-hidden="true"></div>

  <!-- ===== Bottom Dock Player (SoundCloud-like) ===== -->
  <div id="scDock" aria-label="SoundCloud Dock Player">
    <!-- Transport -->
    <div class="dock-transport">
      <button class="btn btn--icon" id="btnPrev" title="Previous" aria-label="Previous">
        <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6V6zm3.5 6L20 18V6l-10.5 6z"/></svg>
      </button>
      <button class="btn btn--round" id="btnPlay" title="Play/Pause" aria-label="Play">
        <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
      </button>
      <button class="btn btn--icon" id="btnNext" title="Next" aria-label="Next">
        <svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2V6zM4 18l10.5-6L4 6v12z"/></svg>
      </button>
    </div>

    <!-- Center (seek) -->
    <div class="dock-center">
      <div class="time" id="tCur">0:00</div>
      <div class="seek" id="seek">
        <div class="seek-rail"></div>
        <div class="seek-fill" id="seekFill"></div>
        <div class="seek-handle" id="seekHandle"></div>
      </div>
      <div class="time" id="tDur">0:00</div>
    </div>

    <!-- Right (volume + track) -->
    <div class="dock-right">
      <div class="vol" title="Volume">
        <div class="btn btn--icon" id="btnMute" aria-label="Mute/Unmute">
          <svg id="iconVol" viewBox="0 0 24 24"><path d="M3 10v4h4l5 5V5L7 10H3zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03z"/></svg>
          <svg id="iconMuted" viewBox="0 0 24 24" style="display:none"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21L16.29 13c.14-.32.21-.66.21-1zm4.5 0c0 2.5-1.28 4.67-3.2 5.93l-1.42-1.42A5.97 5.97 0 0 0 18 12c0-1.58-.6-3.03-1.58-4.11l1.42-1.42A7.96 7.96 0 0 1 21 12zM3 10v4h4l5 5V5L7 10H3zm16.19 11.19-16-16 1.41-1.41 16 16-1.41 1.41z"/></svg>
        </div>
        <div class="vol-rail" id="volRail">
          <div class="vol-fill" id="volFill" style="inset:0 25% 0 0"></div>
        </div>
      </div>

      <div class="track">
        <div class="art"><img id="artImg" alt="" /></div>
        <div class="meta">
          <div class="title" id="metaTitle">Detroit Techno</div>
          <div class="artist" id="metaArtist">SoundCloud playlist</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Canvas ===== -->
  <canvas id="renderCanvas"></canvas>

  <!-- ===== Publish (Issue s JSONem) ===== -->
  <script>
    function collectGalleryData() {
      const out = {
        settings: {
          safeWall:   +document.getElementById('safeWall').value   || 1,
          cornerSafe: +document.getElementById('cornerSafe').value || 1,
          frame: {
            width:  +document.getElementById('frmW').value      || 2,
            height: +document.getElementById('frmH').value      || 2,
            border: +document.getElementById('frmBorder').value || 0.2,
            color:  document.getElementById('frmColor').value   || '#717171'
          },
          counts: {
            front: +document.getElementById('cntFront').value || 0,
            back:  +document.getElementById('cntBack').value  || 0,
            left:  +document.getElementById('cntLeft').value  || 0,
            right: +document.getElementById('cntRight').value || 0
          }
        },
        front: [], back: [], left: [], right: []
      };
      if (!window.framesByWall) return out;
      for (const wall of Object.keys(framesByWall)) {
        out[wall] = (framesByWall[wall] || []).map(it => ({
          img:   it.data.src   || '',
          label: it.data.title || '',
          href:  it.data.url   || ''
        })));
      }
      return out;
    }

    function openPrefilledIssueWithJson(jsonString) {
      const title = encodeURIComponent('Update gallery');
      const body  = encodeURIComponent(jsonString);
      const url   = `https://github.com/PhaserStore/Babylon/issues/new?title=${title}&body=${body}`;

      if (url.length > 7500) {
        try {
          navigator.clipboard.writeText(jsonString);
          alert('JSON je moc dlouh√Ω pro URL, zkop√≠roval jsem ho do schr√°nky. Vlo≈æ ho ruƒçnƒõ do tƒõla issue.');
          window.open(`https://github.com/PhaserStore/Babylon/issues/new?title=${title}`, '_blank', 'noopener');
        } catch {
          alert('JSON je moc dlouh√Ω pro URL. Zkop√≠ruj pros√≠m JSON ruƒçnƒõ.');
          window.open(`https://github.com/PhaserStore/Babylon/issues/new?title=${title}`, '_blank', 'noopener');
        }
        return;
      }
      window.open(url, '_blank', 'noopener');
    }

    document.getElementById('publishBtn').addEventListener('click', async () => {
      try {
        const dataObj = (window.lastAppliedGalleryData && Object.keys(window.lastAppliedGalleryData).length)
          ? window.lastAppliedGalleryData
          : collectGalleryData();

        const minified = JSON.stringify(dataObj);
        JSON.parse(minified);
        localStorage.setItem('draftGalleryJson', minified);
        openPrefilledIssueWithJson(minified);
        if (window.hint) hint('Export odesl√°n do GitHub Issue (nov√° z√°lo≈æka).');
      } catch (e) {
        console.warn('Export selhal ‚Äì collectGalleryData()', e);
        if (window.hint) hint('Export selhal ‚Äì viz konzoli.');
      }
    });

    async function loadGallery() {
      try {
        const res = await fetch('./data/gallery.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        window.galleryData = data;
        if (window.assignDataAllWalls) assignDataAllWalls(data);
      } catch (e) {
        console.warn('Nepoda≈ôilo se naƒç√≠st data/gallery.json (mo≈æn√° zat√≠m neexistuje).', e);
      }
    }
    loadGallery();
  </script>

  <!-- ===== Hlavn√≠ skript ===== -->
  <script>
  "use strict";

  const MODE = { ADMIN: "admin", VIEW: "view" };
  let mode = MODE.VIEW; // start ve VIEW
  const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || Math.min(window.innerWidth, window.innerHeight) <= 900;
  const IS_IOS = /iP(ad|hone|od)/.test(navigator.userAgent);

  /* ==== SoundCloud LAZY-LOAD + Dock Player ==== */
  const SC_PLAYLIST_URL = "https://soundcloud.com/vertigo01/sets/detroit-techno";
  let scWidget = null, scReady = false, scLoading = false;
  let scDuration = 0;        // ms
  let scMuted = false;
  let wantedVolume = 75;     // 0..100

  function loadScApiOnce(){
    return new Promise((resolve, reject)=>{
      if (window.SC && window.SC.Widget) return resolve();
      const s = document.createElement('script');
      s.src = "https://w.soundcloud.com/player/api.js";
      s.async = true;
      s.onload = ()=> resolve();
      s.onerror = ()=> reject(new Error("SC API failed to load"));
      document.head.appendChild(s);
    });
  }

  function mountHiddenIframeOnce(){
    return new Promise((resolve)=>{
      const host = document.getElementById('scIframeHidden');
      if (!host) return resolve(null);
      let iframe = host.querySelector('iframe');
      if (iframe) return resolve(iframe);

      const url = "https://w.soundcloud.com/player/?"
        + "url=" + encodeURIComponent(SC_PLAYLIST_URL)
        + "&auto_play=false&hide_related=true&show_comments=false"
        + "&show_user=false&show_reposts=false&show_teaser=false&visual=false";

      iframe = document.createElement('iframe');
      iframe.id = "scIframe";
      iframe.title = "SoundCloud Player";
      iframe.allow = "autoplay";
      iframe.setAttribute("scrolling","no");
      iframe.setAttribute("frameborder","no");
      iframe.width = "1"; iframe.height="1"; iframe.src = url;

      host.innerHTML = "";
      host.appendChild(iframe);
      resolve(iframe);
    });
  }

  function initScWidgetOnce(){
    return new Promise((resolve)=>{
      const iframe = document.getElementById('scIframe');
      if (!iframe || !window.SC || !window.SC.Widget) return resolve(null);
      if (scWidget) return resolve(scWidget);

      scWidget = window.SC.Widget(iframe);
      scWidget.bind(window.SC.Widget.Events.READY, ()=>{
        scReady = true;

        // Nastaven√≠ volume
        setVolumeUI(wantedVolume);
        scWidget.setVolume(wantedVolume);

        // Naƒçti titul/cover a d√©lku
        refreshTrackMeta();

        // Eventy
        scWidget.bind(window.SC.Widget.Events.PLAY,  ()=>{ setPlayState(true);  refreshTrackMeta(); });
        scWidget.bind(window.SC.Widget.Events.PAUSE, ()=>{ setPlayState(false); });
        scWidget.bind(window.SC.Widget.Events.FINISH,()=>{ /* auto next u≈æ ≈ôe≈°√≠ widget; UI srovn√° PLAY_PROGRESS */ });
        scWidget.bind(window.SC.Widget.Events.PLAY_PROGRESS, (e)=>{
          // e.currentPosition (ms), e.relativePosition (0..1)
          scDuration = Math.max(scDuration, e?.duration || 0);
          updateSeek(e.currentPosition || 0, e.relativePosition || 0);
        });

        resolve(scWidget);
      });
    });
  }

  async function ensureScReadyAndPlay(toggleOnly=false){
    if (scLoading) return;
    scLoading = true;
    try{
      await loadScApiOnce();
      await mountHiddenIframeOnce();
      const w = await initScWidgetOnce();
      if (w){
        if (toggleOnly){
          w.toggle();
        }else{
          w.play(); // v r√°mci u≈æivatelsk√©ho gesta ‚Üí povoleno
        }
      }
    }catch(e){
      console.warn("SC lazy-load failed:", e);
    }finally{
      scLoading = false;
    }
  }

  /* ===== Dock UI helpers ===== */
  const $ = (id)=>document.getElementById(id);
  const iconPlay  = $("iconPlay");
  const iconPause = $("iconPause");
  const tCur = $("tCur");
  const tDur = $("tDur");
  const seek = $("seek");
  const seekFill = $("seekFill");
  const seekHandle = $("seekHandle");
  const volRail = $("volRail");
  const volFill = $("volFill");
  const artImg = $("artImg");
  const metaTitle = $("metaTitle");
  const metaArtist = $("metaArtist");
  const btnPlay = $("btnPlay");
  const btnPrev = $("btnPrev");
  const btnNext = $("btnNext");
  const btnMute = $("btnMute");
  const iconVol = $("iconVol");
  const iconMuted = $("iconMuted");

  function fmtTime(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return h>0 ? `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}` : `${m}:${String(sec).padStart(2,'0')}`;
  }

  function setPlayState(isPlaying){
    iconPlay.style.display = isPlaying ? "none" : "";
    iconPause.style.display = isPlaying ? "" : "none";
    btnPlay.setAttribute("aria-label", isPlaying ? "Pause" : "Play");
  }

  function setVolumeUI(v){ // 0..100
    v = Math.max(0, Math.min(100, v|0));
    wantedVolume = v;
    volFill.style.inset = `0 ${100-v}% 0 0`;
    if (scReady && scWidget) scWidget.setVolume(v);
    if (v===0 || scMuted){
      iconVol.style.display = "none";
      iconMuted.style.display = "";
    } else {
      iconVol.style.display = "";
      iconMuted.style.display = "none";
    }
  }

  function updateSeek(curMs, rel){
    const r = Math.max(0, Math.min(1, rel || (scDuration? curMs/scDuration : 0)));
    seekFill.style.inset = `0 ${100 - r*100}% 0 0`;
    seekHandle.style.left = `${r*100}%`;
    tCur.textContent = fmtTime(curMs);
    if (scDuration>0) tDur.textContent = fmtTime(scDuration);
  }

  function refreshTrackMeta(){
    if (!scWidget) return;
    scWidget.getCurrentSound((s)=>{
      if (!s) return;
      // artwork
      let art = s.artwork_url || (s.user && s.user.avatar_url) || "";
      // vy≈°≈°√≠ rozli≈°en√≠
      if (art) art = art.replace("-large.jpg", "-t500x500.jpg");
      if (artImg) artImg.src = art || "";
      // texty
      metaTitle.textContent = s.title || "Unknown track";
      metaArtist.textContent = (s.user && s.user.username) ? s.user.username : (s.publisher_metadata?.artist || "SoundCloud");
    });
    scWidget.getDuration((d)=>{
      scDuration = d || 0;
      tDur.textContent = fmtTime(scDuration);
    });
    // Po pauze m≈Ø≈æe b√Ωt pozice 0 ‚Äì dot√°hneme p≈ôes getPosition
    scWidget.getPosition((p)=> updateSeek(p||0, scDuration? (p/scDuration) : 0));
  }

  // === Listeners (Dock) ===
  btnPlay.addEventListener("click", ()=> {
    if (!scReady) { ensureScReadyAndPlay(); return; }
    scWidget.toggle();
  });

  btnPrev.addEventListener("click", ()=> { scReady ? scWidget.prev() : ensureScReadyAndPlay(true); });
  btnNext.addEventListener("click", ()=> { scReady ? scWidget.next() : ensureScReadyAndPlay(true); });

  // Mute toggle
  btnMute.addEventListener("click", ()=>{
    scMuted = !scMuted;
    if (scReady && scWidget && scWidget.setMuted) {
      scWidget.setMuted(scMuted);
    }
    if (scMuted){ iconVol.style.display="none"; iconMuted.style.display=""; }
    else { iconVol.style.display=""; iconMuted.style.display="none"; }
  });

  // Volume drag/click
  const volSetFromEvent = (ev)=>{
    const rect = volRail.getBoundingClientRect();
    const x = (ev.touches ? ev.touches[0].clientX : ev.clientX) - rect.left;
    const r = Math.max(0, Math.min(1, x / rect.width));
    setVolumeUI(Math.round(r*100));
  };
  volRail.addEventListener("pointerdown", (e)=>{ volSetFromEvent(e); volRail.setPointerCapture(e.pointerId); });
  volRail.addEventListener("pointermove", (e)=>{ if (e.pressure>0) volSetFromEvent(e); });

  // Seek click/drag
  const seekToEvent = (ev)=>{
    const rect = seek.getBoundingClientRect();
    const x = (ev.touches ? ev.touches[0].clientX : ev.clientX) - rect.left;
    const r = Math.max(0, Math.min(1, x / rect.width));
    if (!scReady){ ensureScReadyAndPlay(); return; }
    const target = Math.round((scDuration || 0) * r);
    scWidget.seekTo(target);
    updateSeek(target, r);
  };
  seek.addEventListener("pointerdown", (e)=>{ seekToEvent(e); seek.setPointerCapture(e.pointerId); });
  seek.addEventListener("pointermove", (e)=>{ if (e.pressure>0) seekToEvent(e); });

  // ====== Zbytek tv√© aplikace (Babylon + galerie) ======

  // P≈ôedrender font≈Ø
  async function ensurePoppins() {
    if (document?.fonts?.load) {
      try {
        await document.fonts.load('400 16px Poppins');
        await document.fonts.load('600 16px Poppins');
        await document.fonts.ready;
      } catch(e) {}
    }
  }

  // Edge/Safari DPR snapping
  function snapDpr(raw) {
    const v = Math.max(1, Math.min(raw || 1, 3));
    const steps = [1, 1.25, 1.5, 2, 2.5, 3];
    let pick = steps[0], best = Infinity;
    for (const s of steps){ const d = Math.abs(s - v); if (d < best){ best = d; pick = s; } }
    return pick;
  }
  const DPR_RAW = window.devicePixelRatio || 1;
  const DPR = snapDpr(DPR_RAW);

  const hintEl = document.getElementById("hint");
  function hint(msg){ if(hintEl) hintEl.textContent=msg; }
  function isTyping(e){ const t=e.target?.tagName?.toLowerCase(); return t==="input"||t==="textarea"||t==="select"||e.target?.isContentEditable; }

  function setMode(m){
    mode = m;
    document.body.classList.toggle('view', m === MODE.VIEW);
    document.body.classList.toggle('admin', m === MODE.ADMIN);
    hint(m === MODE.ADMIN ? "ADMIN m√≥d: nastaven√≠ povoleno" : "VIEW m√≥d: ƒçist√° v√Ωstava");

    // P≈ôi p≈ôechodu do VIEW pauzneme (u≈æivatel spust√≠ Play ruƒçnƒõ)
    if (m === MODE.VIEW){
      if (scReady && scWidget) scWidget.pause();
    }
  }

  // Kl√°vesov√© p≈ôep√≠n√°n√≠ (desktop)
  window.addEventListener('keydown',(e)=>{
    if (IS_MOBILE) return;
    if (isTyping(e)) return;
    const k=e.key.toLowerCase();
    if(k==='a') setMode(MODE.ADMIN);
    if(k==='v') setMode(MODE.VIEW);
  }, { passive:true });

  // Pomocn√°: nejbli≈æ≈°√≠ power-of-two
  function nearestPOT(n, cap){ 
    const p = Math.pow(2, Math.round(Math.log2(Math.max(2, n))));
    return Math.min(p, cap || p);
  }

  // Textury ‚Äì z√°klad dle za≈ô√≠zen√≠ (fin√°ln√≠ po z√≠sk√°n√≠ GPU cap)
  const TEX_BASE = IS_MOBILE ? 1024 : 2048;
  let TEX_SIZE = Math.round(TEX_BASE * Math.min(DPR, 2));

  const canvas = document.getElementById("renderCanvas");
  const engine = new BABYLON.Engine(canvas, true, {
    preserveDrawingBuffer:false, stencil:false, antialias:true, adaptToDeviceRatio:false,
    powerPreference: "high-performance"
  });
  if (!window.BABYLON) { console.error("Babylon.js se nenaƒçetl."); }

  // GPU limity
  const CAPS = engine.getCaps ? engine.getCaps() : {};
  const MAX_TEX_CAP = Math.max(512, CAPS.maxTextureSize || 2048);
  const MOBILE_TEX_CAP  = Math.min(MAX_TEX_CAP, 1024);
  const DESKTOP_TEX_CAP = Math.min(MAX_TEX_CAP, 4096);
  TEX_SIZE = nearestPOT(Math.min(TEX_SIZE, IS_MOBILE ? MOBILE_TEX_CAP : DESKTOP_TEX_CAP), IS_MOBILE ? MOBILE_TEX_CAP : DESKTOP_TEX_CAP);

  // anisotropie
  const MAX_ANISO = CAPS.maxAnisotropy || 4;

  // HW scale
  const BASE_LEVEL = Math.max(0.33, Math.min(1 / DPR, 1));
  let currentScaleLevel = Math.round(BASE_LEVEL * 100) / 100;
  function applyHardwareScale(levelOverride){
    const lvl = typeof levelOverride === "number" ? levelOverride : currentScaleLevel;
    engine.setHardwareScalingLevel(Math.round(lvl * 100) / 100);
  }
  applyHardwareScale();

  // mobiln√≠ auto-scale (jemn√Ω)
  const AutoScale = {
    enabled: IS_MOBILE,
    windowMs: 1200,
    warmupMs: 1500,
    lowFpsMs: 30,
    highFpsMs: 17,
    step: 0.05,
    minLevel: 0.33,
    maxLevel: 1.00,
    accMs: 0, frames: 0, lastEval: performance.now()
  };

  let scene, camera, glow, hl;

  const ROOM = { W: 16, D: 30, H: 10.6 };
  const MIN_RADIUS = 0.28;
  const MAX_RADIUS = 40;

  function createScene(){
    scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color4(0.06,0.06,0.06,1);

    camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/2.25, 11.5, new BABYLON.Vector3(0, ROOM.H*0.48, 0), scene);
    camera.attachControl(canvas, true);

    // Anti-flicker
    camera.minZ = 0.2;
    camera.maxZ = 200;

    camera.lowerBetaLimit = 0.1;
    camera.upperBetaLimit = Math.PI - 0.1;
    camera.lowerRadiusLimit = MIN_RADIUS;
    camera.upperRadiusLimit = MAX_RADIUS;

    camera.wheelDeltaPercentage = IS_MOBILE ? 0.18 : 0.22;
    camera.pinchDeltaPercentage = IS_MOBILE ? 0.006 : 0.008;
    camera.inertia = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 0.6 : 0.85;

    new BABYLON.HemisphericLight("h", new BABYLON.Vector3(0,1,0), scene);

    glow = new BABYLON.GlowLayer("gl", scene, { blurKernelSize: IS_MOBILE ? 18 : 48 });
    glow.intensity = IS_MOBILE ? 0.5 : 0.9;

    hl = new BABYLON.HighlightLayer("hl", scene);

    buildRoom();
    buildLED();
    buildGalleryLogo();

    setupPicking();
    setupZoomUX();
    return scene;
  }

  /* =========================
     ROOM + LED
  ========================= */
  function unlit(hex){
    const m=new BABYLON.StandardMaterial("m",scene);
    m.diffuseColor=BABYLON.Color3.FromHexString(hex);
    m.disableLighting=true;
    return m;
  }
  function unlitTex(tex,{doubleSided=false}={}){
    const m=new BABYLON.StandardMaterial("mt",scene);
    m.disableLighting = true;
    m.diffuseTexture  = tex;
    m.emissiveTexture = tex;
    m.backFaceCulling = !doubleSided;
    if (tex) {
      tex.wrapU = tex.wrapV = BABYLON.Texture.CLAMP_ADDRESSMODE;
      tex.updateSamplingMode(BABYLON.Texture.TRILINEAR_SAMPLINGMODE);
      tex.anisotropicFilteringLevel = MAX_ANISO || 4;
    }
    return m;
  }

  function buildRoom(){
    const floor = BABYLON.MeshBuilder.CreateGround("floor",{width:ROOM.W, height:ROOM.D},scene);
    floor.material = unlit("#151515");

    const back = BABYLON.MeshBuilder.CreatePlane("back",{width:ROOM.W, height:ROOM.H},scene);
    back.position.set(0, ROOM.H/2, -ROOM.D/2 + 0.01);
    back.material = unlit("#2b2b2b");
    back.rotation.y = 0;

    const front = BABYLON.MeshBuilder.CreatePlane("front",{width:ROOM.W, height:ROOM.H},scene);
    front.position.set(0, ROOM.H/2,  ROOM.D/2 - 0.01);
    front.material = unlit("#2b2b2b");
    front.rotation.y = Math.PI;

    const ceiling = BABYLON.MeshBuilder.CreateGround("ceiling",{width:ROOM.W, height:ROOM.D},scene);
    ceiling.position.y = ROOM.H;
    ceiling.rotation.x = Math.PI;
    ceiling.material = unlit("#0f0f10");

    const left = BABYLON.MeshBuilder.CreatePlane("leftWall",{width:ROOM.D, height:ROOM.H},scene);
    left.position.set(-ROOM.W/2 + 0.01, ROOM.H/2, 0);
    left.rotation.y = -Math.PI/2;
    left.material = unlit("#242424");

    const right = BABYLON.MeshBuilder.CreatePlane("rightWall",{width:ROOM.D, height:ROOM.H},scene);
    right.position.set( ROOM.W/2 - 0.01, ROOM.H/2, 0);
    right.rotation.y =  Math.PI/2;
    right.material = unlit("#242424");
  }

  function buildLED(){
    const n=new BABYLON.TransformNode("led",scene);
    const t=0.02, inw=0.1;
    const xL=-ROOM.W/2+inw, xR=ROOM.W/2-inw;
    const zF=ROOM.D/2-inw,  zB=-ROOM.D/2+inw;
    const y0=0.04, y1=ROOM.H-0.04;
    const mat=new BABYLON.StandardMaterial("ledMat",scene);
    mat.emissiveColor=BABYLON.Color3.FromHexString("#ffbdf6");
    mat.disableLighting=true;

    const seg=(a,b)=>{
      const d=BABYLON.Vector3.Distance(a,b);
      const m=BABYLON.MeshBuilder.CreateBox("ledSeg",{width:t,height:t,depth:d},scene);
      m.position=B
